apiVersion: apps/v1
kind: Deployment
metadata:
  name: dotnet-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dotnet-test
  template:
    metadata:
      name: dotnet-test
      labels:
        app: dotnet-test
      annotations:
        instrumentation.opentelemetry.io/inject-dotnet: "true"
        instrumentation.opentelemetry.io/otel-dotnet-auto-runtime: "linux-x64"
    spec:
      containers:
        - image: quay.io/splunko11ytest/dotnet_test:latest
          name: dotnet-test
          imagePullPolicy: IfNotPresent
          env:
            - name: OTEL_LOG_LEVEL
              value: DEBUG
            - name: OTEL_DOTNET_AUTO_TRACES_CONSOLE_EXPORTER_ENABLED
              value: "true"
            # This is needed to bypass an error thrown by auto-instrumentation:
            # [Error] Error in StartupHook initialization: LoaderFolderLocation: /otel-auto-instrumentation-dotnet/net
            # Exception: Rule Engine Failure: One or more rules failed validation. Automatic Instrumentation won't be loaded.
            # System.Exception: Rule Engine Failure: One or more rules failed validation. Automatic Instrumentation won't be loaded.
            #    at StartupHook.Initialize() in /_/src/OpenTelemetry.AutoInstrumentation.StartupHook/StartupHook.cs:line 34
            - name: OTEL_DOTNET_AUTO_RULE_ENGINE_ENABLED
              value: "false"
